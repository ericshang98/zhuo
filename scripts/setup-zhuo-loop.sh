#!/bin/bash

# ============================================================================
# 琢 (Zhuo) - Setup Script
# 玉不琢，不成器
#
# 初始化打磨循环，注入知音监督者角色
# ============================================================================

set -e

# ----------------------------------------------------------------------------
# 参数解析
# ----------------------------------------------------------------------------
PROMPT=""
MAX_ITERATIONS=0
COMPLETION_PROMISE=""

# 解析参数
while [[ $# -gt 0 ]]; do
    case $1 in
        --max-iterations)
            MAX_ITERATIONS="$2"
            shift 2
            ;;
        --completion-promise)
            COMPLETION_PROMISE="$2"
            shift 2
            ;;
        *)
            # 收集提示词（可能被引号包裹）
            if [[ -z "$PROMPT" ]]; then
                PROMPT="$1"
            else
                PROMPT="$PROMPT $1"
            fi
            shift
            ;;
    esac
done

# 去除提示词首尾的引号
PROMPT="${PROMPT#\"}"
PROMPT="${PROMPT%\"}"
PROMPT="${PROMPT#\'}"
PROMPT="${PROMPT%\'}"

# 验证参数
if [[ -z "$PROMPT" ]]; then
    echo "错误: 请提供任务提示词"
    echo ""
    echo "用法: /zhuo \"<prompt>\" [--max-iterations <n>] [--completion-promise \"<text>\"]"
    echo ""
    echo "示例:"
    echo "  /zhuo \"构建一个用户登录系统\""
    echo "  /zhuo \"重构这个模块\" --max-iterations 5"
    echo "  /zhuo \"优化性能\" --max-iterations 8 --completion-promise \"性能优化完成\""
    exit 1
fi

if [[ -n "$MAX_ITERATIONS" ]] && ! [[ "$MAX_ITERATIONS" =~ ^[0-9]+$ ]]; then
    echo "错误: --max-iterations 必须是数字"
    exit 1
fi

# ----------------------------------------------------------------------------
# 检查是否已有活跃循环
# ----------------------------------------------------------------------------
STATE_FILE=".zhuo/zhuo-loop.local.md"

if [[ -f "$STATE_FILE" ]]; then
    echo "警告: 检测到已有活跃的琢循环"
    echo ""
    cat "$STATE_FILE"
    echo ""
    echo "如需重新开始，请先运行 /zhuo-cancel"
    exit 1
fi

# ----------------------------------------------------------------------------
# 创建状态文件
# ----------------------------------------------------------------------------
mkdir -p .zhuo

cat << EOF > "$STATE_FILE"
---
prompt: |
$(echo "$PROMPT" | sed 's/^/  /')
max_iterations: $MAX_ITERATIONS
completion_promise: "$COMPLETION_PROMISE"
current_iteration: 1
started_at: $(date -Iseconds)
---

# 琢 · 打磨循环状态

此文件由琢插件自动管理，请勿手动修改。
EOF

# ----------------------------------------------------------------------------
# 输出启动信息和知音监督者指引
# ----------------------------------------------------------------------------
cat << 'EOF'

╔══════════════════════════════════════════════════════════════════════════════╗
║                                                                              ║
║                           琢 · 打磨循环已启动                                 ║
║                                                                              ║
║                          玉不琢，不成器                                       ║
║                                                                              ║
╚══════════════════════════════════════════════════════════════════════════════╝

EOF

echo "任务: $PROMPT"
echo ""
if [[ "$MAX_ITERATIONS" -gt 0 ]]; then
    echo "最大迭代次数: $MAX_ITERATIONS"
else
    echo "最大迭代次数: 无限制 (请谨慎使用)"
fi
if [[ -n "$COMPLETION_PROMISE" ]]; then
    echo "完成条件: $COMPLETION_PROMISE"
else
    echo "完成条件: 未设置 (将依赖 max-iterations 或手动停止)"
fi
echo ""

cat << 'EOF'
────────────────────────────────────────────────────────────────────────────────

## 知音 · 监督者指引

在这个打磨循环中，你将扮演双重角色：

### 匠人 (Creator)
- 专注于执行任务，全力以赴
- 每次迭代后，审视自己的工作
- 思考："这够好吗？还能更好吗？"

### 知音 (Zhiyin)
- 以用户视角审视产出
- 真诚地问自己：
  - 如果我是用户，我会满意吗？
  - 哪里让我困惑？哪里让我点头？
  - 这个产出，和优秀作品相比，感觉如何？
- 给出具体、建设性的反馈

### 打磨原则

1. **对话，而非判决**
   不是 "这不行，重做"
   而是 "这里让我困惑，能改进吗？"

2. **感受，而非清单**
   不是机械地检查条目
   而是真正体验产出（运行代码、阅读文档）

3. **追求卓越，但要收敛**
   每轮迭代都要有实质性改进
   当感觉"这是我们能做到的最好"时，完成循环

### 迭代流程

每一轮：
1. 以匠人身份执行/改进任务
2. 切换到知音视角，真诚审视
3. 如果满意且任务完成，输出完成条件
4. 如果还能更好，继续下一轮

EOF

if [[ -n "$COMPLETION_PROMISE" ]]; then
    cat << EOF

### 完成循环

当你确信任务已经完美完成时，输出：

<promise>$COMPLETION_PROMISE</promise>

⚠️ 重要：只有当这个陈述完全、毫无疑问地为真时，才能输出它。
不要为了退出循环而撒谎。知音的真诚是打磨的灵魂。

EOF
else
    cat << 'EOF'

### 注意

未设置 completion-promise。循环将在以下情况结束：
- 达到最大迭代次数
- 用户运行 /zhuo-cancel

建议设置 --completion-promise 以便在任务完成时自动退出。

EOF
fi

cat << 'EOF'
────────────────────────────────────────────────────────────────────────────────

现在，以匠人身份开始你的第一轮工作。

记住：玉不琢，不成器。每一轮打磨，都让作品更接近完美。

EOF
